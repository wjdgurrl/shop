<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/main.css" rel ="stylesheet">
</head>
<body>
    <div th:replace="~{nav.html::navbar}"></div>
    <div class="detail">
        <h4>상세페이지</h4>
<!--        <a th:href="@{/edit/{id}(id=${items})}">-->
        <h1 th:text="${data.writer}">작성자</h1>
        <!--<img src="https://placehold.co/300">-->
        <img th:src="${data.imgUrl}" alt="상품 이미지" style="max-width: 300px;">
        <h4 th:if="${userId != null}" th:text="${userId}" id="userId" style="display: none">구매자 id</h4>
        <h4 th:text="${data.title}" id="itemTitle">제목</h4>
        <h4 th:text="${data.price + '원'}" id="itemPrice">금액</h4>

        <!--장바구니 추가 버튼-->
        <!-- itemName, price, memberId-->
        <button onclick="addToCart()" th:if="${userId != null}">장바구니 추가</button>
        <div></div>

        <div sec:authorize="isAuthenticated()">
            <a th:href="@{/edit/{id}(id=${data.id})}">수정</a>
            <!--삭제 기능 구현 -->
            <span th:onclick="fetch('/data?id=[[${data.id}]]',{method:'DELETE'})
            .then(r => r.text())
            .then((a) => {
            console.log(a)
                location.reload();
            })
        ">삭제</span>
        </div>


        <!--코멘트 작성 영역-->
        <span sec:authorize="isAnonymous()">
            <div class="comment-input">
                <h2>로그인 하셔야 댓글을 작성할 수 있습니다.</h2>
            </div>
        </span>
        <span sec:authorize="isAuthenticated()">
            <form action="/comment" method="POST">
            <input name = "comment" class="comment-input" placeholder="댓글을 입력해주세요" required>
            <input name = "parent" th:value="${data.id}" style="display:none">
            <button type = "submit">전송</button>
            </form>
        </span>


        <!--저장된 코멘트-->
        <div class="comment-list">
            <!--비어있으면 표시-->
            <div th:if="${#lists.isEmpty(commentPage.content)}">
                <p>첫 댓글을 작성해주세요.</p>
            </div>
            <div th:each="c:${commentPage.content}" class="comment-box">
                <h5 th:text="${c.username}">작성자</h5>
                <h5 th:text="${c.content}">댓글</h5>
                <h6 th:text="${#temporals.format(c.createdAt,'yyyy-MM-dd HH:mm')}">작성시간</h6>
            </div>
        </div>
        <!-- 페이지네이션 -->
        <div class="pagination">
            <!-- 이전 버튼 -->
            <a th:if="${currentPage > 1}"
               th:href="@{/detail/{id}(id=${data.id}, page=${currentPage - 1})}"
               class="prev-button">이전</a>

            <!-- 페이지 번호 버튼 -->
            <span th:if="${totalPages > 0}" th:each="page : ${#numbers.sequence(1, totalPages)}">
            <a th:href="@{/detail/{id}(id=${data.id}, page=${page})}"
                th:text="${page}"
                th:classappend="${page == currentPage} ? 'active' : ''"></a>
            </span>

            <!-- 댓글이 없어서 totalPages가 1인 경우 (1번 버튼만 표시) -->
            <span th:if="${#lists.isEmpty(commentPage.content)}">
            <a th:href="@{/detail/{id}(id=${data.id}, page=1)}"
                th:text="'1'"
                th:classappend="${currentPage == 1} ? 'active' : ''"></a>
            </span>

            <!-- 다음 버튼 -->
            <a th:if="${currentPage < totalPages}"
               th:href="@{/detail/{id}(id=${data.id}, page=${currentPage + 1})}"
               class="next-button">다음</a>
        </div>

    <script>
        <!--삭제기능 -->
        //이 url로 get요청 날려줌

        <!--장바구니 추가 기능-->
        async function addToCart(){
            //1. 상품 정보를 가져오기
            const memberId = document.getElementById("userId").innerHTML;
            const itemName = document.getElementById('itemTitle').innerText; //id = itemName인 html요소를 가져와서 제목 항목을 가져옴
            const itemPrice = document.getElementById('itemPrice').innerText;

            //2. 보낼 데이터를 json으로 구성하기
            const data = {
                itemName: itemName,
                itemPrice: itemPrice,
                memberId: memberId,
            };

            console.log('전송 데이터 ', data);

            try{
                const response = await fetch('/bucket',{
                    method:'POST', //post요청
                    headers:{
                        'Content-Type':'application/json', // 보내는 데이터 형식
                    },
                    body : JSON.stringify(data) //데이터를  JSON문자열로 변환해 전송
                });
                //응답처리
                if (response.ok){
                    const result = await response.json(); // 서버 응답을 json으로 변환
                    alert(result.message); // 성공 메시지 표시
                }else{
                    alert('장바구니 추가 실패!');
                }
            }catch (error){
                console.error('장바구니 추가 중 오류:',error);
            }
        }

    </script>


    </div>
</body>
</html>